"use strict";function _createForOfIteratorHelper(e,t){var a,n,i,s,r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return n=!(a=!0),{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){n=!0,i=e},f:function(){try{a||null==r.return||r.return()}finally{if(n)throw i}}};if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length)return r&&(e=r),s=0,{s:t=function(){},n:function(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){var a;if(e)return"string"==typeof e?_arrayLikeToArray(e,t):"Map"===(a="Object"===(a=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:a)||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var Assets={images:{},imgLoaded:0,imgFiles:[],avatars:{},imagesToLoad:67,load:function(){this.fillFileArrays(),this.loadImages()},loadImages:function(){var t=this,a=new Image;a.crossOrigin="Anonymous",a.src=this.imgFiles[this.imgLoaded],a.onload=function(){var e=a.src.split("/"),e=e[e.length-1].split(".")[0];t.images[e]=a,++t.imgLoaded,t.imgLoaded<t.imgFiles.length?t.loadImages():t.loadAvatarImages("defaultAvatar",!0,null)}},getImage:function(e){return this.images[e]},getImgArray:function(e,t,a){return this.avatars[e][t][a]},fillFileArrays:function(){var e="./textures/floor/";this.imgFiles.push(e+"grass.png"),this.imgFiles.push(e+"default.png"),this.imgFiles.push((e="./textures/misc/")+"shadow.png"),this.imgFiles.push(e+"mouse-tile.png"),this.imgFiles.push(e+"msg-pos.png")},loadAvatarImages:function(e,t,a){var n,i=this,s=(this.avatars[e]={num_loaded:0},this.createAvatarFilesObject(e));for(n in s){this.avatars[e][n]=[];var r,o=0,l=_createForOfIteratorHelper(s[n]);try{for(l.s();!(r=l.n()).done;){var c,h=r.value,d=(this.avatars[e][n].push([]),_createForOfIteratorHelper(h));try{for(d.s();!(c=d.n()).done;){var m=c.value,u=new Image;u.crossOrigin="Anonymous",u.src=m,u.onload=function(){i.avatars[e].num_loaded++,i.avatars[e].num_loaded===i.imagesToLoad&&(null!==a&&(a.images=i.avatars[e]),t)&&game.startGame()},u.onerror=function(){"defaultAvatar"!==e&&(i.avatars[e]=i.avatars.defaultAvatar),null!==a&&(a.images=i.avatars[e])},this.avatars[e][n][o].push(u)}}catch(e){d.e(e)}finally{d.f()}o++}}catch(e){l.e(e)}finally{l.f()}}},createAvatarFilesObject:function(e){if("base"===e)return this.createBaseCharacterFilesObject();for(var t={},a=(t.stand=[["https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=6&head_direction=6"],["https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=7&head_direction=7"],["https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=0&head_direction=0"],["https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=1&head_direction=1","https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=1&head_direction=1&gesture=eyb"],["https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=2&head_direction=2","https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=2&head_direction=2&gesture=eyb"],["https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=3&head_direction=3","https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=3&head_direction=3&gesture=eyb"],["https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=4&head_direction=4","https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=4&head_direction=4&gesture=eyb"],["https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=5&head_direction=5","https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=5&head_direction=5&gesture=eyb"]],t.walk=[],6),n=0;n<8;++n){t.walk.push([]);for(var i=0;i<4;++i)t.walk[n].push("https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction="+a+"&head_direction="+a+"&action=wlk&frame="+i);a=(a+1)%8}t.sit=[["https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=6&head_direction=6&action=sit"],["https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=0&head_direction=0&action=sit"],["https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=2&head_direction=2&action=sit","https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=2&head_direction=2&action=sit&gesture=eyb"],["https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=4&head_direction=4&action=sit","https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=4&head_direction=4&action=sit&gesture=eyb"]],t.wave=[];for(var a=6,s=0;s<8;++s){t.wave.push([]);for(var r=0;r<2;++r)t.wave[s].push("https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction="+a+"&head_direction="+a+"&action=wav&frame="+r);a=(a+1)%8}return t},createBaseCharacterFilesObject:function(){var e={},t="./textures/character/";e.stand=[[t+"bc-stand-0.png"],[t+"bc-stand-1.png"],[t+"bc-stand-2.png"],[t+"bc-stand-3.png",t+"bc-stand-3.png"],[t+"bc-stand-4.png",t+"bc-stand-4.png"],[t+"bc-stand-5.png",t+"bc-stand-5.png"],[t+"bc-stand-6.png",t+"bc-stand-6.png"],[t+"bc-stand-7.png",t+"bc-stand-7.png"]],e.walk=[];for(var a=0;a<8;++a){e.walk.push([]);for(var n=0;n<4;++n)e.walk[a].push(t+"bc-stand-"+a+".png")}e.sit=[[t+"bc-stand-0.png"],[t+"bc-stand-2.png"],[t+"bc-stand-4.png",t+"bc-stand-4.png"],[t+"bc-stand-6.png",t+"bc-stand-6.png"]],e.wave=[];for(var i=0;i<8;++i){e.wave.push([]);for(var s=0;s<2;++s)e.wave[i].push(t+"bc-stand-"+i+".png")}return e}};function _createForOfIteratorHelper(e,t){var a,n,i,s,r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return n=!(a=!0),{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){n=!0,i=e},f:function(){try{a||null==r.return||r.return()}finally{if(n)throw i}}};if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length)return r&&(e=r),s=0,{s:t=function(){},n:function(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){var a;if(e)return"string"==typeof e?_arrayLikeToArray(e,t):"Map"===(a="Object"===(a=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:a)||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var CanvasChat={init:function(){this.players={},this.msgs=[],this.vel=1.5,this.t=-1,this.adjustX=32,this.moveUp=23,this.maxW=345;var e=document.getElementById("app");this.chat=document.createElement("div"),this.chat.style.width=e.clientWidth+"px",this.chat.style.height=e.clientHeight+"px",this.defaultY=e.clientHeight/3,this.chat.id="canvasChat",this.chat.style.position="absolute",this.chat.style.zIndex="1",this.chat.style.pointerEvents="none",e.appendChild(this.chat)},add:function(e){e.html.style.position="fixed";var t=e.html.getElementsByClassName("game-chatMessage")[0],t=(t.className="game-chatMessage game-canvasChatMessage",t.style.maxWidth=this.maxW-18+"px",this.chat.appendChild(e.html),e.html.getBoundingClientRect()),t=(e.width=t.width,e.height=t.height,e.dy=-e.height,e.dx=this.adjustX-e.width/2,e.pos=this.players[e.player.id].pos,delete e.player,delete e.text,Assets.getImage("msg-pos"));(t=t.cloneNode(!0)).style.position="absolute",e.html.appendChild(t),e.playerRef=t,0<this.msgs.length&&(this.move(e,-1),this.clean()),this.msgs.push(e)},touch:function(e,t){var a=Grid.drawPos[e.pos.y][e.pos.x],n=Grid.drawPos[t.pos.y][t.pos.x],a={x:a.x+e.dx,y:e.dy};if((n={x:n.x+t.dx,y:t.dy}).y<a.y&&n.y+t.height>a.y||n.y<a.y+e.height&&n.y+t.height>=a.y+e.height||a.y<=n.y&&n.y+t.height<=a.y+e.height){if(a.x<n.x&&a.x+e.width>n.x)return!0;if(a.x<n.x+t.width&&a.x+e.width>n.x+t.width)return!0;if(n.x<=a.x&&a.x+e.width<=n.x+t.width)return!0}return!1},move:function(e,t){for(var a,n=0;n<this.msgs.length;++n)n!==t&&this.touch(e,this.msgs[n])&&((a=this.msgs[n]).dy,a.height,e.dy,e.height,this.msgs[n].dy=e.dy-this.msgs[n].height,this.move(this.msgs[n],n))},clean:function(){for(var e=0;e<this.msgs.length;++e)this.msgs[e].dy+this.msgs[e].height<=-this.defaultY&&(this.chat.removeChild(this.msgs[e].html),this.msgs.splice(e,1),--e)},update:function(){if(++this.t,this.t>=360/this.vel){var e,t=_createForOfIteratorHelper(this.msgs);try{for(t.s();!(e=t.n()).done;)e.value.dy-=this.moveUp}catch(e){t.e(e)}finally{t.f()}this.t=0,this.clean()}},draw:function(){if(0<this.msgs.length){var e,t=_createForOfIteratorHelper(this.msgs);try{for(t.s();!(e=t.n()).done;){var a=e.value,n=Grid.drawPos[a.pos.y][a.pos.x];a.html.style.left=n.x+a.dx+"px",a.html.style.top=this.defaultY+a.dy+"px",a.playerRef.style.left=a.width/2-4+"px",a.playerRef.style.top=a.height-1+"px"}}catch(e){t.e(e)}finally{t.f()}}},clear:function(){this.msgs=[],this.chat.innerHTML=""}},Chat={socket:null,playerName:null,maxMsgLength:136,minChatWidth:150,maxFileSize:314572800,allowedTypes:["image","video","audio"],init:function(){WavRecorder.init()},create:function(){this.createChatPanel(),this.bindChatEvents()},remove:function(){var e=document.getElementById("app"),t=document.getElementsByClassName("game-chat")[0],a=document.getElementsByClassName("game-chatResize")[0],n=document.getElementsByClassName("game-hideChatButton")[0],i=document.getElementsByClassName("game-menu")[0],s=document.getElementsByClassName("game-chatInput")[0];e.removeChild(t),e.removeChild(a),e.removeChild(n),i.removeChild(s)},createChatPanel:function(){var e=document.getElementById("app"),t=document.createElement("div"),a=(t.className="game-chat",document.createElement("div")),n=(a.className="game-chatMessagesContainer",document.createElement("div")),i=(n.className="game-chatResize",document.createElement("button")),a=(i.className="game-hideChatButton",i.innerHTML="<",t.appendChild(a),e.appendChild(t),e.appendChild(n),e.appendChild(i),document.getElementsByClassName("game-menu")[0]),t=(this.micB=document.createElement("button"),this.micB.className="game-mic",WavRecorder.available||(this.micB.className+=" game-disabled",this.micB.setAttribute("disabled","")),document.createElement("img")),n=(t.src="textures/icons/mic.png",this.micB.appendChild(t),document.createElement("div"));n.className="game-chatInput",this.chatInput=document.createElement("input"),this.chatInput.type="text",this.chatInput.maxlength=this.maxMsgLength,n.appendChild(this.micB),n.appendChild(this.chatInput),a.appendChild(n)},bindChatEvents:function(){var a=this,e=(this.chatInput.onkeypress=function(e){var t=a.chatInput.value.trim();t.length>=a.maxMsgLength&&46!==e.keyCode&&8!==e.keyCode&&13!==e.keyCode?e.preventDefault():13===e.keyCode&&""!==t&&(a.chatInput.value="",e={type:"text",text:t=t.slice(0,a.maxMsgLength)},a.socket.emit("chat message",e),e.player={name:a.playerName,id:a.playerId},a.addMsg(e))},this.micB.onmousedown=function(e){WavRecorder.start()},document.getElementById("app")),t=(e.onmouseup=function(e){var t;WavRecorder.recording&&((t=WavRecorder.stop()).name="OpenChat-"+a.playerName+a.timeString()+".wav",a.readFile(t))},e.onkeydown=function(e){27===e.keyCode&&WavRecorder.recording&&WavRecorder.cancel()},this.chatInput.onblur=function(e){a.chatInputFocus()},document.getElementsByClassName("game-hideChatButton")[0]),n=document.getElementsByClassName("game-chat")[0],i=document.getElementsByClassName("game-chatResize")[0];t.onclick=function(){n.style.transition="0.5s",t.style.transition="0.5s";var e=n.getBoundingClientRect();e.left<0?(t.innerHTML="<",n.style.left="0",t.style.left=e.width+"px",i.style.display="block"):(t.innerHTML=">",n.style.left=-e.width+"px",t.style.left="0",i.style.display="none")}},chatInputFocus:function(){var e=navigator.userAgent.toLowerCase().includes("android"),t=navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i);e||t||this.chatInput.focus()},timeString:function(){var e=new Date,t=this.twoDigitString(e.getMonth()+1),a=this.twoDigitString(e.getDate()),n=this.twoDigitString(e.getHours()),i=this.twoDigitString(e.getMinutes()),s=this.twoDigitString(e.getSeconds());return e.getFullYear()+t+a+n+i+s},twoDigitString:function(e){return""+(e=e<10?"0"+e:e)},checkAndReadFile:function(e){this.allowedFile(e)&&this.readFile(e)},readFile:function(t){var a=this,e=new FileReader;e.onload=function(e){e=e.target.result,e={type:e.substring(5,20).split(";")[0],data:e,filename:t.name};a.socket.emit("file message",e),e.player={name:a.playerName,id:a.playerId},a.addFileMsg(e)},e.readAsDataURL(t)},addFileMsg:function(e){var t=e.type.split("/")[0];"image"===t?this.addImageMsg(e):"video"===t?this.addVideoMsg(e):"audio"===t&&this.addAudioMsg(e)},addImageMsg:function(t){var a=this,n=document.createElement("div"),e=(n.className="game-chatMessageC",document.createElement("div")),i=(e.className="game-chatMessage",document.createElement("span")),s=(i.className="game-boldText",i.style.float="left",i.textContent=t.player.name+":",document.getElementsByClassName("game-chatMessagesContainer")[0]),r=document.createElement("div"),o=new Image,l=(o.className="game-file",this.addFullWindow(o),o.onload=function(){s.appendChild(n),s.scrollTop=s.scrollHeight,delete t.data,t.html=n.cloneNode(!0);var e=t.html.getElementsByTagName("img")[0];a.addFullWindow(e),CanvasChat.add(t)},o.src=t.data,this.createFileLink(t));r.appendChild(o),r.appendChild(l),e.appendChild(i),e.appendChild(r),n.appendChild(e)},addFullWindow:function(n){n.onclick=function(){var e=document.getElementById("app"),t=document.createElement("div"),a=(t.className="game-fullWinPanel",e.appendChild(t),t.onclick=function(){e.removeChild(t)},new Image);a.className="game-fullWinImg",a.src=n.src,t.appendChild(a)}},addVideoMsg:function(a){var e,t,n,i,s=document.createElement("div"),r=(s.className="game-chatMessageC",document.createElement("div")),o=(r.className="game-chatMessage",document.createElement("span")),l=(o.className="game-boldText",o.style.float="left",o.textContent=a.player.name+":",document.getElementsByClassName("game-chatMessagesContainer")[0]);"video/mp4"===a.type?(e=document.createElement("div"),(t=document.createElement("video")).setAttribute("controls",""),t.className="game-file",t.onloadeddata=function(){l.appendChild(s),l.scrollTop=l.scrollHeight},t.src=a.data,(n=t.cloneNode(!0)).onloadeddata=function(){a.html=s.cloneNode(!0);var e=a.html.getElementsByClassName("game-chatMessage")[0].getElementsByTagName("div")[0],t=e.getElementsByTagName("video");0<t.length&&e.removeChild(t[0]),e.insertBefore(n,e.firstChild),CanvasChat.add(a)},t.load(),n.load(),i=this.createFileLink(a),e.appendChild(t),e.appendChild(i)):e=this.createFileLink(a),r.appendChild(o),r.appendChild(e),s.appendChild(r),"video/mp4"!==a.type&&(l.appendChild(s),l.scrollTop=l.scrollHeight,a.html=s.cloneNode(!0),CanvasChat.add(a))},addAudioMsg:function(e){var t,a,n,i=document.createElement("div"),s=(i.className="game-chatMessageC",document.createElement("div")),r=(s.className="game-chatMessage",document.createElement("span")),o=(r.className="game-boldText",r.style.float="left",r.textContent=e.player.name+":",document.getElementsByClassName("game-chatMessagesContainer")[0]);"audio/mpeg"===e.type||"audio/wav"===e.type||"audio/mp3"===e.type?(t=document.createElement("div"),(a=document.createElement("audio")).setAttribute("controls",""),a.className="game-file",a.onloadeddata=function(){o.appendChild(i),o.scrollTop=o.scrollHeight,delete e.data,e.html=i.cloneNode(!0),CanvasChat.add(e)},a.src=e.data,a.load(),n=this.createFileLink(e),t.appendChild(a),t.appendChild(n)):t=this.createFileLink(e),s.appendChild(r),s.appendChild(t),i.appendChild(s),"audio/mpeg"!==e.type&&"audio/wav"!==e.type&&"audio/mp3"!==e.type&&(o.appendChild(i),o.scrollTop=o.scrollHeight,e.html=i.cloneNode(!0),CanvasChat.add(e))},createFileLink:function(e){var t=document.createElement("a"),a=(t.innerHTML="Download "+e.type.split("/")[0]+" file",this.dataURItoBlob(e)),a=URL.createObjectURL(a);return t.setAttribute("href",a),t.setAttribute("download",e.filename),t.setAttribute("target","_blank"),t},addMsg:function(e){for(var t=document.createElement("div"),a=(t.className="game-chatMessageC",document.createElement("div")),n=(a.className="game-chatMessage",document.createElement("span")),i=(n.className="game-boldText",n.textContent=e.player.name+":",document.createElement("span")),s=new RegExp("(https?://[^<>\\s]+)","gi"),r=s.exec(e.text),o=0;null!==r;){r.index>o&&(l=document.createTextNode(e.text.substring(o,r.index)),i.appendChild(l)),o=s.lastIndex;var l=document.createElement("a"),c=document.createTextNode(r[0]);l.appendChild(c),l.setAttribute("href",r[0]),l.setAttribute("target","_blank"),i.appendChild(l),r=s.exec(e.text)}e.text.length>o&&(h=document.createTextNode(e.text.substring(o,e.text.length)),i.appendChild(h)),a.appendChild(n),a.appendChild(i),t.appendChild(a);var h=document.getElementsByClassName("game-chatMessagesContainer")[0];h.appendChild(t),h.scrollTop=h.scrollHeight,e.html=t.cloneNode(!0),CanvasChat.add(e)},addInfoMsg:function(e){var t=document.createElement("div"),a=(t.className="game-chatMessageC",document.createElement("div")),e=(a.className="game-chatMessage game-chatInfoMessage game-boldText",a.textContent=e,t.appendChild(a),document.getElementsByClassName("game-chatMessagesContainer")[0]);e.appendChild(t),e.scrollTop=e.scrollHeight},allowedFile:function(e){if(!(e.size>this.maxFileSize))for(var t=0;t<this.allowedTypes.length;++t)if(e.type.split("/")[0]===this.allowedTypes[t])return!0;return!1},dataURItoBlob:function(e){for(var t=atob(e.data.split(",")[1]),a=new ArrayBuffer(t.length),n=new Uint8Array(a),i=0;i<t.length;++i)n[i]=t.charCodeAt(i);return new Blob([a],{type:e.type})}};function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"===_typeof(e)?e:String(e)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var a=e[Symbol.toPrimitive];if(void 0===a)return("string"===t?String:Number)(e);a=a.call(e,t||"default");if("object"!==_typeof(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}var Game=function(){function e(){_classCallCheck(this,e),this.player=null,this.room=null,this.roomsList=null,this.maxNickLength=15,this.delta=0,this.fps=60,this.timestep=1e3/this.fps,this.lastFrameTimeMs=0,this.frame=null,this.socket=io({reconnection:!1}),this.canvasCtx=null,this.maskCanvasCtx=null,this.d={x:0,y:0},this.initialPos={x:0,y:0},this.mouse=null,this.mousedown=!1,this.disableClick=!1,this.resizedown=!1,this.mouseCell=null,this.configureSocket(),Chat.socket=this.socket,this.setDragEvents(),this.getPlayerName()}return _createClass(e,[{key:"setDragEvents",value:function(){var t=this,e=document.getElementById("app");e.ondragover=function(e){e.preventDefault()},e.ondragend=function(e){e.preventDefault()},e.ondrop=function(e){e.preventDefault(),null!==t.room&&(e=e.dataTransfer.files[0],Chat.checkAndReadFile(e))}}},{key:"joinRoom",value:function(e){var t;null===this.room?(Chat.create(),this.createCanvas(),this.bindEvents(),CanvasChat.init(),(t=document.getElementById("app")).style.backgroundImage="none",t.style.backgroundColor="#010101",this.leaveB.style.display="inline-block",this.frame=requestAnimationFrame(this.gameLoop.bind(this))):Chat.addInfoMsg("You left "+this.room.name),this.mouseCell=null,this.room=new Room({client:!0}),this.room.update(e),this.player=this.room.players[this.player.id],Grid.size=this.room.size,Grid.center(this.canvasCtx.canvas.width,this.canvasCtx.canvas.height),Grid.createDrawOrder(),CanvasChat.clear(),Chat.chatInputFocus(),Chat.addInfoMsg("You joined "+this.room.name)}},{key:"leaveRoom",value:function(){this.room=null,this.leaveB.style.display="none",cancelAnimationFrame(this.frame),this.frame=null,this.fpsSpan.innerHTML="fps: 0",Chat.remove(),this.hidePlayerInfo();var e=document.getElementById("app"),t=document.getElementsByClassName("game-canvas")[0],a=document.getElementsByClassName("game-canvas")[1];e.removeChild(t),e.removeChild(a),e.removeChild(CanvasChat.chat),e.style.backgroundImage='url("../textures/misc/background.jpg")',e.style.backgroundColor="#10436f"}},{key:"startGame",value:function(){this.createMenu(),Chat.init()}},{key:"gameLoop",value:function(e){var t=e-this.lastFrameTimeMs;if(this.delta+=t,this.lastFrameTimeMs=e,this.delta>=this.timestep){for(this.fpsSpan.innerHTML="fps: "+parseInt(1e3/t);this.delta>=this.timestep;)this.update(),this.delta-=this.timestep;this.draw()}this.frame=requestAnimationFrame(this.gameLoop.bind(this))}},{key:"update",value:function(){null!==this.room&&(this.room.updateLogic(),CanvasChat.update()),this.d={x:0,y:0},null!==this.mouse&&(this.d.x+=this.mouse.clientX-this.initialPos.x,this.d.y+=this.mouse.clientY-this.initialPos.y,Grid.move(this.d),Grid.createDrawOrder(),this.initialPos.x=this.mouse.clientX,this.initialPos.y=this.mouse.clientY,this.mouse=null)}},{key:"draw",value:function(){var e=this.canvasCtx,t=this.maskCanvasCtx;e.fillStyle="#010101",e.fillRect(0,0,e.canvas.width,e.canvas.height),t.fillStyle="#ffffff",t.fillRect(0,0,t.canvas.width,t.canvas.height),null!==this.room&&(this.room.draw(e,t,this.mouseCell),CanvasChat.draw())}},{key:"bindEvents",value:function(){var n=this,e=document.getElementsByClassName("game-canvas")[0],t=document.getElementsByClassName("game-canvas")[1],i=document.getElementsByTagName("body")[0],s=(i.onresize=function(){null!==n.room&&(e.height=e.clientHeight,e.width=e.clientWidth,t.height=t.clientHeight,t.width=t.clientWidth,Grid.center(t.width,t.height),Grid.createDrawOrder(),CanvasChat.chat.height=t.height,CanvasChat.chat.width=t.width,CanvasChat.defaultY=t.height/3)},document.getElementsByClassName("game-chatResize")[0]),r=document.getElementsByClassName("game-chat")[0],o=document.getElementsByClassName("game-hideChatButton")[0],l=document.getElementsByClassName("game-chatMessagesContainer")[0];s.onmousedown=function(e){n.resizedown=!0,n.xIni=e.clientX},t.onmousedown=function(e){n.mousedown=!0,n.initialPos.x=e.clientX,n.initialPos.y=e.clientY},document.onmousemove=function(e){var t,a;null!==n.room&&(n.mousedown?(n.mouse=e,n.disableClick=!0):n.resizedown&&(r.style.transition="none",o.style.transition="none",t=e.clientX-n.xIni,(t=r.getBoundingClientRect().width+t)<Chat.minChatWidth?t=Chat.minChatWidth:t+5>i.clientWidth&&(t=i.clientWidth-5),a=t-5,r.style.width=t+"px",s.style.left=a+"px",o.style.left=t+"px",l.scrollTop=l.scrollHeight,n.xIni=e.clientX))},document.onmouseup=function(e){null!==n.room&&(n.mousedown=!1,n.resizedown=!1,Chat.chatInputFocus())},t.onclick=function(e){var t;n.disableClick||(null!==(t=n.playerAt(e.clientX,e.clientY))?(n.socket.emit("click",t.pos),n.showPlayerInfo(t)):null!==(t=Grid.cellAt(e.clientX,e.clientY))&&(n.socket.emit("click",t),n.hidePlayerInfo())),n.disableClick=!1},t.onmousemove=function(e){n.mouseCell=Grid.cellAt(e.clientX,e.clientY)}}},{key:"playerAt",value:function(e,t){var e=this.maskCanvasCtx.getImageData(e,t,1,1);return 0===e.data[0]?(t=e.data[2],e=Object.keys(this.room.players),this.room.players[e[t]]):null}},{key:"createCanvas",value:function(){var e=document.getElementById("app"),t=document.createElement("canvas"),t=(t.className="game-canvas",this.maskCanvasCtx=t.getContext("2d",{willReadFrequently:!0}),e.appendChild(t),t.height=t.clientHeight,t.width=t.clientWidth,document.createElement("canvas"));t.className="game-canvas",this.canvasCtx=t.getContext("2d"),e.appendChild(t),t.height=t.clientHeight,t.width=t.clientWidth}},{key:"configureSocket",value:function(){var t=this;this.socket.on("check name",function(e){e.res?(t.player=new Player({name:e.name,id:t.socket.id,client:!0}),Chat.playerName=t.player.name,Chat.playerId=t.player.id,document.getElementById("app").innerHTML="",t.createInfoSpans(),Assets.load(),Assets.loadAvatarImages(t.player.name,!1,t.player),t.socket.emit("new player",t.player.name)):1===e.errno?alert("Name must be 4 to 15 characters long."):2===e.errno&&alert("Your name is being used by another player.")}),this.socket.on("chat message",function(e){Chat.addMsg(e)}),this.socket.on("file message",function(e){Chat.addFileMsg(e)}),this.socket.on("online players",function(e){t.playersSpan.innerHTML="online: "+e}),this.socket.on("rooms list",function(e){t.roomsList=e,t.createRoomsWindow()}),this.socket.on("room info",function(e){null===t.room||e.name!==t.room.name?t.joinRoom(e):t.room.update(e),CanvasChat.players=t.room.players}),this.socket.on("left room",function(){t.leaveRoom()}),this.socket.on("player join",function(e){Chat.addInfoMsg(e+" joined the room")}),this.socket.on("player left",function(e){Chat.addInfoMsg(e+" left the room")}),this.socket.on("disconnect",function(){alert("Disconnected from the server.")})}},{key:"showPlayerInfo",value:function(e){this.hidePlayerInfo();var t=document.getElementById("app"),a=document.createElement("div"),n=(a.className="game-playerInfo",document.createElement("p")),i=(n.innerHTML=e.name,document.createElement("div")),s=document.createElement("img"),e=e.images.stand[6][0];s.src=e.src,s.onload=function(){a.appendChild(n),i.appendChild(s),a.appendChild(i),t.appendChild(a)}}},{key:"hidePlayerInfo",value:function(){var e=document.getElementsByClassName("game-playerInfo");0<e.length&&(e=e[0],document.getElementById("app").removeChild(e))}},{key:"createRoomsWindow",value:function(){var i,s,e,t,a,n,r,o,l,c=this;0===document.getElementsByClassName("game-window").length&&(i=document.getElementById("app"),(s=document.createElement("div")).className="game-window-container",(e=document.createElement("div")).className="game-window",(t=document.createElement("div")).className="game-window-header flex-center",(a=document.createElement("span")).className="game-window-title",a.innerHTML="Browser",(n=document.createElement("span")).className="game-closeButton flex-center",n.onclick=function(){i.removeChild(s)},(r=document.createElement("span")).innerHTML="X",n.appendChild(r),t.appendChild(a),t.appendChild(n),(r=document.createElement("div")).className="game-window-body",(o=document.createElement("div")).className="game-rooms-list",l="background-soft-blue",this.roomsList.forEach(function(e){var t=document.createElement("div"),a=(t.className="game-room-row",t.className+=" "+l,l="background-soft-blue"===l?"background-transparent":"background-soft-blue",document.createElement("span")),n=(a.className="game-room-players",0===e.players?a.className+=" background-grey":a.className+=" background-green",a.innerHTML=e.players,document.createElement("span"));n.className="game-room-name",n.innerHTML=e.name,t.appendChild(a),t.appendChild(n),t.onclick=function(){c.socket.emit("join room",e.name),i.removeChild(s)}.bind(e),o.appendChild(t)}),r.appendChild(o),e.appendChild(t),e.appendChild(r),s.appendChild(e),i.appendChild(s))}},{key:"createMenu",value:function(){var e=this,t=document.getElementById("app"),a=document.createElement("div"),n=(a.className="game-menu",this.leaveB=document.createElement("button"),this.leaveB.style.display="none",document.createElement("img")),i=(n.src="textures/icons/back.png",document.createElement("button")),s=(i.className="game-icon-flicker",document.createElement("img"));s.src="textures/icons/rooms.png",this.leaveB.onclick=function(){e.socket.emit("leave room")},i.onclick=function(){i.className="",e.socket.emit("rooms list")},this.leaveB.appendChild(n),i.appendChild(s),a.appendChild(this.leaveB),a.appendChild(i),t.appendChild(a)}},{key:"createInfoSpans",value:function(){var e=document.getElementById("app");this.fpsSpan=document.createElement("span"),this.fpsSpan.className="game-infoSpan",this.fpsSpan.innerHTML="fps: 0",e.appendChild(this.fpsSpan),this.playersSpan=document.createElement("span"),this.playersSpan.className="game-infoSpan",this.playersSpan.style.top=this.fpsSpan.clientHeight+"px",this.playersSpan.innerHTML="online: 0",e.appendChild(this.playersSpan)}},{key:"getPlayerName",value:function(){var t=this,e=document.getElementById("app"),a=document.createElement("div"),n=(a.className="game-login-container",document.createElement("div")),i=(n.className="game-login",document.createElement("div")),s=document.createElement("input"),r=(s.type="text",s.placeholder="Nickname",s.onkeydown=function(e){s.value.trim().length>=t.maxNickLength&&"Delete"!==e.code&&"Backspace"!==e.code&&"Enter"!==e.code&&"NumpadEnter"!==e.code&&e.preventDefault()},document.createElement("div")),o=document.createElement("button");o.innerHTML="<span>PLAY</span>",o.onclick=function(){var e=s.value.trim();""!==e&&t.socket.emit("check name",e)},n.onkeydown=function(e){"Enter"!==e.code&&"NumpadEnter"!==e.code||o.onclick()},i.appendChild(s),r.appendChild(o),n.appendChild(i),n.appendChild(r),a.appendChild(n),e.appendChild(a),s.focus()}}]),e}();function _createForOfIteratorHelper(e,t){var a,n,i,s,r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return n=!(a=!0),{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){n=!0,i=e},f:function(){try{a||null==r.return||r.return()}finally{if(n)throw i}}};if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length)return r&&(e=r),s=0,{s:t=function(){},n:function(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){var a;if(e)return"string"==typeof e?_arrayLikeToArray(e,t):"Map"===(a="Object"===(a=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:a)||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var Grid={size:40,originX:0,originY:0,tileW:64,tileL:40,dx:32,dy:16,drawOrdered:[],drawPos:[],setOrigin:function(e,t){this.originX=e-this.dx,this.originY=t},center:function(e,t){var a=(2*this.size-1)*this.dy;this.originX=e/2-this.dx,this.originY=(t-a)/2},move:function(e){this.originX+=e.x,this.originY+=e.y},cellAt:function(e,t){var a,n=_createForOfIteratorHelper(this.drawOrdered);try{for(n.s();!(a=n.n()).done;){var i=a.value,s=this.drawPos[i.y][i.x],r=s.x+this.dx,o=s.y+this.dy,l=e-r,c=t-o;if(Math.abs(l)/this.dx+Math.abs(c)/this.dy<=1)return i}}catch(e){n.e(e)}finally{n.f()}return null},createDrawOrder:function(){this.drawOrdered=[],this.drawPos=[];for(var e=0;e<this.size;++e){this.drawPos.push([]);for(var t=0;t<this.size;++t)this.drawPos[e].push({})}for(var a,n,i,s=this.originX,r=this.originY,o=0;o<2*this.size-1;++o){for(a=o<this.size?(n=0,i=this.size-1-o,s-o*this.dx):(n=o-this.size+1,i=0,s-(2*this.size-o-2)*this.dx);n<this.size&&i<this.size;){var l={x:a,y:r};this.drawOrdered.push({x:i,y:n}),this.drawPos[n][i]=l,++n,++i,a+=this.tileW}r+=this.dy}}};function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"===_typeof(e)?e:String(e)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var a=e[Symbol.toPrimitive];if(void 0===a)return("string"===t?String:Number)(e);a=a.call(e,t||"default");if("object"!==_typeof(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}var params={velocity:1.3,framesPerImgWalk:6,adjustY:-84,adjustX:0,X:[0,1,1,1,0,-1,-1,-1],Y:[-1,-1,0,1,1,1,0,-1]},Player=function(){function t(e){_classCallCheck(this,t),this.name=e.name,this.id=e.id,this.room=e.room||null,this.pos=e.pos||null,this.status="out",this.direction=e.direction||-1,this.animFrame=-1,this.walkd={x:0,y:0},this.images=[],this.client=e.client||!1,this.target=e.target||null,this.nextPos=e.nextPos||null,this.click=null}return _createClass(t,[{key:"update",value:function(e,t){this.direction===e.direction&&this.status===e.status||this.changeAnim(e.direction,e.status),null===t||null===this.pos||this.pos.x===e.pos.x&&this.pos.y===e.pos.y||(t.updatePlayerCell(this.pos,e.pos,this.id),this.walkd={x:0,y:0}),this.pos=e.pos,this.target=e.target,this.nextPos=e.nextPos}},{key:"reset",value:function(){this.room=null,this.pos=null,this.status="out",this.direction=-1,this.animFrame=-1,this.walkd={x:0,y:0},this.images=[],this.target=null,this.nextPos=null,this.click=null}},{key:"changeAnim",value:function(e,t){this.direction=e,this.status=t,this.animFrame=-1,this.walkd={x:0,y:0}}},{key:"getPosDirection",value:function(e,t){var a=e.x-t.x,e=e.y-t.y;return 0===a&&0===e?this.direction:0===a&&0<e?0:a<0&&0<e?1:a<0&&0===e?2:a<0&&e<0?3:0===a&&e<0?4:0<a&&e<0?5:0<a&&0===e?6:7}},{key:"changeDirection",value:function(e){"stand"===this.status&&(e=this.getPosDirection(this.pos,e),this.direction=e)}},{key:"move",value:function(e,t){for(var a=params.X,n=params.Y,i=this.pos,s=t.size,r=[],o=0;o<s;++o){r.push([]);for(var l=0;l<s;++l)r[o].push({x:-1,y:-1})}r[i.y][i.x]={x:e.x,y:e.y};for(var c=[i];0<c.length;){var h=c[0];if(c.splice(0,1),h.x===e.x&&h.y===e.y)break;for(var d=this.getPosDirection(h,e),m=0;m<8;++m){var u,p=(d+m)%8,p={x:h.x+a[p],y:h.y+n[p]};p.x<0||s<=p.x||p.y<0||s<=p.y||0<=r[p.y][p.x].x||null===(u=t.cell(p.x,p.y))||0<u.players.length||(r[p.y][p.x]=h,c.push(p))}}if(-1!==r[e.y][e.x].x){for(var g=r[e.y][e.x],y=e;g.x!==i.x||g.y!==i.y;)y=r[y.y][y.x],g=r[g.y][g.x];var f=this.getPosDirection(i,y),f={pos:this.pos,target:e,nextPos:y,direction:f,status:"walk"};this.update(f,t)}}},{key:"stop",value:function(){this.target=null,this.nextPos=null,this.changeAnim(this.direction,"stand")}},{key:"sit",value:function(){this.direction%2!=0&&(this.direction=(this.direction+1)%8),this.changeAnim(this.direction,"sit")}},{key:"wave",value:function(){this.changeAnim(this.direction,"wave")}},{key:"updateLogic",value:function(e){var t;"walk"===this.status?this.updateLogicWalk(e):(null!==this.click&&(null!==(t=e.cell(this.click.x,this.click.y))&&(0<t.players.length?this.changeDirection(t.pos):this.move(t.pos,e)),this.click=null),"stand"===this.status||"sit"===this.status?this.updateLogicStand():this.updateLogicWave())}},{key:"updateLogicWave",value:function(){++this.animFrame,250===this.animFrame&&this.changeAnim(this.direction,"stand")}},{key:"updateLogicStand",value:function(){++this.animFrame,246===this.animFrame&&(this.animFrame=0)}},{key:"updateLogicWalk",value:function(e){var t,a=[.5,1,.5,2,.5,1,.5,2];this.walkd.x+=a[this.direction]*[-2,0,2,1,2,0,-2,-1][this.direction]*params.velocity,this.walkd.y+=a[this.direction]*[-1,-1,-1,0,1,1,1,0][this.direction]*params.velocity,1<Math.abs(this.walkd.x/64)+Math.abs(this.walkd.y/32)&&(this.walkd.x=0,this.walkd.y=0,e.updatePlayerCell(this.pos,this.nextPos,this.id),this.pos=this.nextPos,a=!1,null!==this.click&&(null!==(t=e.cell(this.click.x,this.click.y))&&0===t.players.length&&(this.move(t.pos,e),a=!0),this.click=null),a||(this.nextPos.x===this.target.x&&this.nextPos.y===this.target.y||0<e.cell(this.target.x,this.target.y).players.length?this.stop():this.move(this.target,e))),++this.animFrame,this.animFrame===4*params.framesPerImgWalk&&(this.animFrame=0)}},{key:"draw",value:function(e,t,a,n){switch(this.status){case"stand":this.drawStand(e,t,a,n);break;case"walk":this.drawWalk(e,t,a,n);break;case"sit":this.drawSit(e,t,a,n);break;case"wave":this.drawWave(e,t,a,n)}}},{key:"drawStand",value:function(e,t,a,n){var i=this.images[this.status][this.direction],s=Assets.getImage("shadow");e.drawImage(s,parseInt(t.x),parseInt(t.y-6)),1===i.length||this.animFrame<240?(e.drawImage(i[0],parseInt(t.x+params.adjustX),parseInt(t.y+params.adjustY)),this.drawMask(i[0],a,n,parseInt(t.x+params.adjustX),parseInt(t.y+params.adjustY))):(e.drawImage(i[1],parseInt(t.x+params.adjustX),parseInt(t.y+params.adjustY)),this.drawMask(i[1],a,n,parseInt(t.x+params.adjustX),parseInt(t.y+params.adjustY)))}},{key:"drawSit",value:function(e,t,a,n){var i=this.images[this.status][this.direction/2],s=Assets.getImage("shadow");e.drawImage(s,parseInt(t.x),parseInt(t.y-6)),1===i.length||this.animFrame<240?(e.drawImage(i[0],parseInt(t.x+params.adjustX),parseInt(t.y+params.adjustY+15)),this.drawMask(i[0],a,n,parseInt(t.x+params.adjustX),parseInt(t.y+params.adjustY+15))):(e.drawImage(i[1],parseInt(t.x+params.adjustX),parseInt(t.y+params.adjustY+15)),this.drawMask(i[1],a,n,parseInt(t.x+params.adjustX),parseInt(t.y+params.adjustY+15)))}},{key:"drawWalk",value:function(e,t,a,n){var i=this.images[this.status][this.direction],s=Assets.getImage("shadow"),s=(e.drawImage(s,parseInt(t.x+this.walkd.x),parseInt(t.y-6+this.walkd.y)),i[parseInt(this.animFrame/params.framesPerImgWalk)]);e.drawImage(s,parseInt(t.x+params.adjustX+this.walkd.x),parseInt(t.y+params.adjustY+this.walkd.y)),this.drawMask(s,a,n,parseInt(t.x+params.adjustX+this.walkd.x),parseInt(t.y+params.adjustY+this.walkd.y))}},{key:"drawWave",value:function(e,t,a,n){var i=this.images[this.status][this.direction],s=Assets.getImage("shadow"),s=(e.drawImage(s,parseInt(t.x),parseInt(t.y-6)),parseInt(this.animFrame%10/5));e.drawImage(i[s],parseInt(t.x+params.adjustX),parseInt(t.y+params.adjustY)),this.drawMask(i[s],a,n,parseInt(t.x+params.adjustX),parseInt(t.y+params.adjustY))}},{key:"drawMask",value:function(e,t,a,n,i){e=this.createPlayerMask(e,a);t.drawImage(e,n,i)}},{key:"createPlayerMask",value:function(e,t){for(var a=document.createElement("canvas"),n=(a.width=e.width,a.height=e.height,a.getContext("2d")),i=(n.fillStyle="rgba(0,0,0,0)",n.fillRect(0,0,a.width,a.height),n.drawImage(e,0,0),n.getImageData(0,0,a.width,a.height)),s=0;s<i.data.length;s+=4)255===i.data[s+3]&&(i.data[s]=0,i.data[s+1]=0,i.data[s+2]=t);return n.putImageData(i,0,0),a}}]),t}();function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _createForOfIteratorHelper(e,t){var a,n,i,s,r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return n=!(a=!0),{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){n=!0,i=e},f:function(){try{a||null==r.return||r.return()}finally{if(n)throw i}}};if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length)return r&&(e=r),s=0,{s:t=function(){},n:function(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){var a;if(e)return"string"==typeof e?_arrayLikeToArray(e,t):"Map"===(a="Object"===(a=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:a)||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"===_typeof(e)?e:String(e)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var a=e[Symbol.toPrimitive];if(void 0===a)return("string"===t?String:Number)(e);a=a.call(e,t||"default");if("object"!==_typeof(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}"undefined"!=typeof module&&(module.exports=Player);var Room=function(){function t(e){_classCallCheck(this,t),this.name=e.name||"New Room",this.size=e.size||10,this.array=e.array||[],this.spawn=e.spawn||{x:0,y:0},this.spawnDirection=e.spawnDirection||4,this.players=e.players||{},this.client=e.client||!1}return _createClass(t,[{key:"update",value:function(e){var t,a={};for(t in e.players){var n=void 0;void 0===this.players[t]?(n=new Player(e.players[t]),void 0===Assets.avatars[n.name]?(Assets.loadAvatarImages(n.name,!1,n),n.images=Assets.avatars.defaultAvatar):n.images=Assets.avatars[n.name]):n=this.players[t],n.client=!0,n.update(e.players[t],this),n.room=this.name,a[t]=n}this.players=a,this.name=e.name,this.size=e.size,this.array=e.array,this.spawn=e.spawn}},{key:"setPlayersRoom",value:function(){for(var e in this.players)this.players[e].room=this.name}},{key:"cell",value:function(e,t){var a=this.array[t][e];return null!==a&&(a.pos={x:e,y:t}),a}},{key:"join",value:function(e){(this.players[e.id]=e).room=this.name,e.pos=this.spawn,e.changeAnim(this.spawnDirection,"stand");var t=this.array[this.spawn.y][this.spawn.x];t.players.push(e.id),this.array[this.spawn.y][this.spawn.x]=t}},{key:"leave",value:function(e){var t=this.players[e],a=this.array[t.pos.y][t.pos.x],n=a.players.indexOf(e);a.players.splice(n,1),this.array[t.pos.y][t.pos.x]=a,this.players[e].reset(),delete this.players[e]}},{key:"clear",value:function(){for(var e in this.players)this.leave(e)}},{key:"updatePlayerCell",value:function(e,t,a){var e=this.array[e.y][e.x],n=e.players.indexOf(a);e.players.splice(n,1),(e=this.array[t.y][t.x]).players.push(a)}},{key:"updateLogic",value:function(){for(var e in this.players)this.players[e].updateLogic(this)}},{key:"draw",value:function(e,t,a){var n,i,s=Grid.drawOrdered,r=_createForOfIteratorHelper(s);try{for(r.s();!(n=r.n()).done;){var o,l,c=n.value,h=this.array[c.y][c.x];null!==h&&(o=Grid.drawPos[c.y][c.x],l=Assets.getImage(h.material),e.drawImage(l,parseInt(o.x),parseInt(o.y)))}}catch(e){r.e(e)}finally{r.f()}null!==a&&null!==this.array[a.y][a.x]&&(a=Grid.drawPos[a.y][a.x],i=Assets.getImage("mouse-tile"),e.drawImage(i,parseInt(a.x),parseInt(a.y-3)));var d,m=Object.keys(this.players),u=_createForOfIteratorHelper(s);try{for(u.s();!(d=u.n()).done;){var p=d.value,g=this.array[p.y][p.x];if(null!==g&&0<g.players.length){var y,f=Grid.drawPos[p.y][p.x],v=_createForOfIteratorHelper(g.players);try{for(v.s();!(y=v.n()).done;){var w=y.value,b=m.indexOf(w);this.players[w].draw(e,f,t,b)}}catch(e){v.e(e)}finally{v.f()}}}}catch(e){u.e(e)}finally{u.f()}}}]),t}(),WavRecorder=("undefined"!=typeof module&&(module.exports=Room),{available:!1,sampleRate:null,volume:1,leftchannel:[],rightchannel:[],recordingLength:0,recording:!1,init:function(){navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(WavRecorder.success).catch(function(e){alert("Audio capture not supported in this browser.")})},success:function(e){window.AudioContext=window.AudioContext||window.webKitAudioContext;var a=WavRecorder,t=(a.available=!0,new AudioContext),n=(a.sampleRate=t.sampleRate,t.createScriptProcessor(1024,2,2));n.onaudioprocess=function(e){var t;a.recording&&(t=e.inputBuffer.getChannelData(0),e=e.inputBuffer.getChannelData(1),a.leftchannel.push(new Float32Array(t)),a.rightchannel.push(new Float32Array(e)),a.recordingLength+=1024)},t.createMediaStreamSource(e).connect(n),n.connect(t.destination)},start:function(){this.recording=!0,this.leftchannel=[],this.rightchannel=[],this.recordingLength=0},cancel:function(){this.recording=!1},stop:function(){this.recording=!1;for(var e=this.mergeBuffers(this.leftchannel,this.recordingLength),t=this.mergeBuffers(this.rightchannel,this.recordingLength),a=this.interleave(e,t),e=new ArrayBuffer(44+2*a.length),n=new DataView(e),i=(this.writeUTFBytes(n,0,"RIFF"),n.setUint32(4,44+2*a.length,!0),this.writeUTFBytes(n,8,"WAVE"),this.writeUTFBytes(n,12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,2,!0),n.setUint32(24,this.sampleRate,!0),n.setUint32(28,4*this.sampleRate,!0),n.setUint16(32,4,!0),n.setUint16(34,16,!0),this.writeUTFBytes(n,36,"data"),n.setUint32(40,2*a.length,!0),a.length),s=44,r=this.volume,o=0;o<i;++o)n.setInt16(s,a[o]*(32767*r),!0),s+=2;return new Blob([n],{type:"audio/wav"})},mergeBuffers:function(e,t){for(var a=new Float32Array(t),n=0,i=e.length,s=0;s<i;++s){var r=e[s];a.set(r,n),n+=r.length}return a},interleave:function(e,t){for(var a=e.length+t.length,n=new Float32Array(a),i=e.length,s=0,r=0;r<i;++r)n[s++]=e[r],n[s++]=t[r];return n},writeUTFBytes:function(e,t,a){for(var n=a.length,i=0;i<n;++i)e.setUint8(t+i,a.charCodeAt(i))}});